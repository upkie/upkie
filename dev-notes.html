<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>upkie: Developer notes</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">upkie<span id="projectnumber">&#160;10.0.0</span>
   </div>
   <div id="projectbrief">Open-source wheeled biped robots</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dev-notes.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Developer notes </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#custom-hardware">Custom hardware</a><ul><li class="level2"><a href="#autotoc_md24">URDF requirements</a><ul><li class="level3"><a href="#autotoc_md25">1. Joint names</a></li>
<li class="level3"><a href="#autotoc_md26">2. IMU link</a></li>
<li class="level3"><a href="#autotoc_md27">3. Sagittal vector</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#dev-workflow">Development workflow</a><ul><li class="level2"><a href="#cpp-dev-workflow">C++ development</a></li>
<li class="level2"><a href="#python-dev-workflow">Python development</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md28">Inter-process communication</a></li>
<li class="level1"><a href="#spine-state-machine">Spine state machine</a></li>
<li class="level1"><a href="#autotoc_md29">[Advanced] Design notes</a><ul><li class="level2"><a href="#autotoc_md30">Single spine binary</a></li>
<li class="level2"><a href="#autotoc_md31">Source code headers</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_dev_notes"></a></p>
<h1><a class="anchor" id="custom-hardware"></a>
Custom hardware</h1>
<p >Upkie's motion control software can apply to other wheeled-biped robots with different hardware, as long as they use the same mjbots actuators and electronics. When making a custom robot, the step by step instructions from the Wiki should work, replacing of course Step 2 on 3D printing with your own parts. The Raspberry Pi setup and electronics testing will be the unchanged. This section details the requirements to be able to pass the <a href="https://github.com/upkie/upkie/wiki/5%29-Motion-control-software">motion control software step</a>. See also <a href="https://github.com/orgs/upkie/discussions/517">#517</a>.</p>
<h2><a class="anchor" id="autotoc_md24"></a>
URDF requirements</h2>
<p >Upkie's software makes the following assumptions about the wheeled-biped robot description.</p>
<h3><a class="anchor" id="autotoc_md25"></a>
1. Joint names</h3>
<p >Your description has six revolute joints named: <code>left_hip</code>, <code>left_knee</code>,<code>left_wheel</code>, <code>right_hip</code>, <code>right_knee</code>, <code>right_wheel</code>.</p>
<p >You can add more joints, but if they are not "fixed" joints you will also need to customize the software to send proper joint actions to them. (By default, the Bullet interface will send zero-torque commands to unknown mobile joints.) The recommended path of customization is to set all new joints to type="fixed" first and check that balancing works in simulation. Once this works, free the joints and customize their actions.</p>
<h3><a class="anchor" id="autotoc_md26"></a>
2. IMU link</h3>
<p >There is a virtual link named <code>imu</code> whose frame matches the frame of your robot's IMU.</p>
<h3><a class="anchor" id="autotoc_md27"></a>
3. Sagittal vector</h3>
<p >The <a href="https://en.wikipedia.org/wiki/Sagittal_plane">sagittal</a> vector of your robot, defined as the vector pointing from the back to the front of its trunk, corresponds to the x-axis of its base-link frame.</p>
<p >See also <a href="https://github.com/upkie/upkie/issues/527">#527</a>.</p>
<h1><a class="anchor" id="dev-workflow"></a>
Development workflow</h1>
<p >While newcomers will likely run <code>start_simulation.sh</code> and import the <code>upkie</code> package in Python, as you get acquainted with the robot and develop your own agents (in your fork of the repository or using the <a href="https://github.com/upkie/new_agent">new_agent</a> template), you may want to contribute some features back upstream. Here is a short guide on compiling from source to do that.</p>
<h2><a class="anchor" id="cpp-dev-workflow"></a>
C++ development</h2>
<p >The C++ development workflow consists of Makefile rules. First, setup a build environment following the instructions for your system:</p>
<ul>
<li><a href="https://github.com/orgs/upkie/discussions/100">Fedora</a></li>
<li><a href="https://github.com/orgs/upkie/discussions/159">macOs</a></li>
<li><a href="https://github.com/orgs/upkie/discussions/101">Ubuntu</a></li>
</ul>
<p >To upload software to the robot, you will also need to define the <code>UPKIE_NAME</code> environment variable. Assuming the hostname of your Upkie is "michel-strogoff", for example, you can add the following to your shell configuration file:</p>
<div class="fragment"><div class="line">export UPKIE_NAME=&quot;michel-strogoff&quot;</div>
</div><!-- fragment --><p >An IP address will also work.</p>
<p >To make sure your build environment works, try to rebuild the <a class="el" href="spines.html#pi3hat-spine">pi3hat spine</a> from source:</p>
<div class="fragment"><div class="line">make build</div>
</div><!-- fragment --><p >You can then upload it by <code>make upload</code> and check that it runs on the Raspberry Pi of your Upkie:</p>
<div class="fragment"><div class="line">$ ssh user@upkie</div>
<div class="line">user@upkie:~$ cd upkie</div>
<div class="line">user@upkie:upkie$ make run_pi3hat_spine</div>
</div><!-- fragment --><p >Once the spine is running, you can run any agent in a separate shell on the robot, for example the PID balancer from the examples directory:</p>
<div class="fragment"><div class="line">user@upkie:upkie$ python -m mpc_balancer</div>
</div><!-- fragment --><h2><a class="anchor" id="python-dev-workflow"></a>
Python development</h2>
<p >The Python development workflow is based on <a href="https://pixi.sh/">Pixi</a>. You can list the available tasks with a dry:</p>
<div class="fragment"><div class="line">pixi run</div>
</div><!-- fragment --><p >For instance:</p>
<ul>
<li>Build and open the documentation: <code>pixi run open-docs</code></li>
<li>Check linting: <code>pixi run lint</code></li>
<li>Check unit tests: <code>pixi run -e test-py12 test</code></li>
<li>Open a shell in a fully configured environment: <code>pixi shell</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md28"></a>
Inter-process communication</h1>
<p >Upkie implements an action-observation loop to control robot actuators from a standalone "agent" process. The inter-process communication (IPC) protocol between the agent and the "spine" process that talks to actuators looks like this:</p>
<p ><img src="action-observation-loop.png" alt="Action-observation loop" class="inline"/> </p>
<p >The agent can be a simple Python script with few dependencies. This separation between agent and spine provides a robot/simulation switch to train or test agents in a simulation spine before running them on a real robot.</p>
<p >This protocol is suitable for <a href="https://en.wiktionary.org/wiki/real-time#English">real-time</a> but not high-frequency (&gt; 1000 Hz) performance, which is fine for balancing and locomotion on Upkies. (If you are wondering whether Python is suitable for real-time applications, we were too, until we <a href="https://github.com/orgs/upkie/discussions/240">tried it out</a>.) All design decisions have their pros and cons. Some pros for this design are:</p>
<ul>
<li>Run the same Python code on simulated and real robots</li>
<li>Interfaces with to the <a href="https://mjbots.com/products/mjbots-pi3hat-r4-4b">mjbots pi3hat</a> and mjbots actuators</li>
<li>Interfaces with to the <a href="http://bulletphysics.org/">Bullet</a> simulator</li>
<li>Observer pipeline to extend observations</li>
<li>Soft real-time: spine-agent loop interactions are predictable and repeatable</li>
<li>Unit tested, and not only with end-to-end tests</li>
</ul>
<p >Meanwhile, cons against this design include:</p>
<ul>
<li>Low frequency: designed for tasks that run in the 1â€“400 Hz range (like balancing)</li>
<li>Soft rather than hard real-time guarantee: the code is empirically reliable by a large margin, that's it</li>
<li>Weakly-typed IPC: typing is used within agents and spines, but the interface between them is only checked at runtime</li>
</ul>
<h1><a class="anchor" id="spine-state-machine"></a>
Spine state machine</h1>
<p >Spines run a state machine depicted in the following diagram:</p>
<div class="image">
<img src="state-machine.png" alt=""/>
</div>
 <p >States have the following purposes:</p>
<ul>
<li><b>Stop:</b> do nothing, send stop commands to servos.</li>
<li><b>Reset:</b> apply runtime configuration to the spine's actuation interface and observers.<ul>
<li>The reset state is not time-critical, <em>i.e.</em>, configuration can take time.</li>
<li>When exiting the reset state, the spine writes observations back to the agent.</li>
</ul>
</li>
<li><b>Idle:</b> do nothing.</li>
<li><b>Act:</b> send action to the actuation interface and write observation back to the agent.</li>
<li><b>Shutdown:</b> terminal state, exit the control loop.</li>
</ul>
<p >There are three possible events:</p>
<ul>
<li><code>BEGIN</code>: beginning of a control cycle.</li>
<li><code>END</code>: end of a control cycle.</li>
<li><code>SIGINT</code>: the process received an interrupt signal.</li>
</ul>
<p >Guards (in blue), <em>i.e.</em> conditions required to trigger a transition, may involve two variables:</p>
<ul>
<li><code>req</code>: the current <a class="el" href="namespaceupkie_1_1cpp_1_1spine_acce48d7e5cfa6b01bd3ad20460c2707b.html#acce48d7e5cfa6b01bd3ad20460c2707b">Request</a> from the agent.</li>
<li><code>stop_cycles</code>: the number of stop commands cycled in the current state (only available in "stop" and "shutdown" states).</li>
</ul>
<p >Read/write operations from/to the shared memory are indicated in red.</p>
<h1><a class="anchor" id="autotoc_md29"></a>
[Advanced] Design notes</h1>
<h2><a class="anchor" id="autotoc_md30"></a>
Single spine binary</h2>
<p >We want a single spine binary per interface: Bullet, pi3hat, etc. That binary may offer several observer and controller pipelines, configured via the command line.</p>
<ul>
<li>Pros:<ul>
<li>Combinatorial complexity in distributing, installing and running different spines.</li>
<li>Allows <code>Upkie-Spine-*</code> Gymnasium environment names</li>
<li>Simpler for users, especially newcomers.</li>
</ul>
</li>
<li>Cons:<ul>
<li>Combinatorial complexity makes the code branching.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md31"></a>
Source code headers</h2>
<p >All C++ source files should start with the license line:</p>
<div class="fragment"><div class="line"><span class="comment">// SPDX-License-Identifier: Apache-2.0</span></div>
</div><!-- fragment --><p >All Python source files should start with the following four lines:</p>
<div class="fragment"><div class="line"><span class="comment">#!/usr/bin/env python3</span></div>
<div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div>
<div class="line"><span class="comment">#</span></div>
<div class="line"><span class="comment"># SPDX-License-Identifier: Apache-2.0</span></div>
</div><!-- fragment --><p >Optionally, license lines can be followed by copyright lines corresponding to the various contributions to the file (those are optional as in most legal systems copyright is automatically conferred upon the creation of an original work, without the need for a notice), and author lines to identify the individuals who contributed them. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
