<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>upkie: Observations</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">upkie<span id="projectnumber">&#160;9.0.1</span>
   </div>
   <div id="projectbrief">Open-source wheeled biped robots</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('observations.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Observations </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md11">Base orientation</a></li>
<li class="level1"><a href="#autotoc_md12">Floor contact</a><ul><li class="level2"><a href="#autotoc_md13">Wheel contact</a></li>
</ul>
</li>
<li class="level1"><a href="#history-observer">History observer</a></li>
<li class="level1"><a href="#autotoc_md14">IMU</a></li>
<li class="level1"><a href="#autotoc_md15">Servo</a></li>
<li class="level1"><a href="#autotoc_md16">Simulation-only</a><ul><li class="level2"><a href="#autotoc_md17">Floating base</a></li>
<li class="level2"><a href="#autotoc_md18">IMU non-observables</a></li>
<li class="level2"><a href="#autotoc_md19">Rigid bodies</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md20">Wheel odometry</a></li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_docs_observations"></a></p>
<p >Spines compute observation dictionaries from sensor measurements by applying <em>observers</em> one after the other in a sequence called the <em>observer pipeline</em>. This page lists the outputs of available observers, using shorthands <code>a.b.c</code> for nested dictionary keys <code>observation["a"]["b"]["c"]</code>.</p>
<h1><a class="anchor" id="autotoc_md11"></a>
Base orientation</h1>
<ul>
<li>Observer: <a class="el" href="classupkie_1_1cpp_1_1observers_1_1BaseOrientation.html">BaseOrientation</a></li>
<li>Spine observation key: <code>base_orientation</code></li>
</ul>
<p >The base orientation observer estimates the orientation of the floating base with respect to the world frame.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>base_orientation.angular_velocity</code>   </td><td class="markdownTableBodyNone">Body angular velocity vector of the base frame in rad/s    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>base_orientation.pitch</code>   </td><td class="markdownTableBodyNone">Pitch angle of the base frame relative to the world frame, in radians   </td></tr>
</table>
<p ><img src="https://upkie.github.io/upkie/observers.png" alt="" align="right" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md12"></a>
Floor contact</h1>
<ul>
<li>Observer: <a class="el" href="classupkie_1_1cpp_1_1observers_1_1FloorContact.html">FloorContact</a></li>
<li>Spine observation key: <code>floor_contact</code></li>
</ul>
<p >The floor contact observer detects contact between the wheels and the floor. The PID balancer used for testing relies on this observer, for instance, to reset its integrator while the robot is in the air, to avoid fast-spinning wheels at touchdown.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>contact</code>   </td><td class="markdownTableBodyNone">Boolean contact state    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>left_wheel</code>   </td><td class="markdownTableBodyNone">Wheel contact observation for the left wheel    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>right_wheel</code>   </td><td class="markdownTableBodyNone">Wheel contact observation for the right wheel    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>upper_leg_torque</code>   </td><td class="markdownTableBodyNone">Mean squared upper-leg torques in N⋅m   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md13"></a>
Wheel contact</h2>
<ul>
<li>Observer: <a class="el" href="classupkie_1_1cpp_1_1observers_1_1WheelContact.html">WheelContact</a></li>
<li>Spine observation key: <code>floor_contact.left_wheel</code> and <code>floor_contact.right_wheel</code></li>
</ul>
<p >Internally, the floor contact observer relies on two wheel contact observers, one for each wheel, as listed above.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>abs_acceleration</code>   </td><td class="markdownTableBodyNone">Low-pass filtered absolute wheel acceleration in rad/s²    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>abs_torque</code>   </td><td class="markdownTableBodyNone">Low-pass filtered absolute wheel torque in N⋅m    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>contact</code>   </td><td class="markdownTableBodyNone">Current contact state (boolean)   </td></tr>
</table>
<p>| <code>inertia</code> | Apparent inertia I = |torque| / |acceleration| at the wheel |</p>
<h1><a class="anchor" id="history-observer"></a>
History observer</h1>
<ul>
<li>Observer: <a class="el" href="classupkie_1_1cpp_1_1observers_1_1HistoryObserver.html">HistoryObserver</a></li>
<li>Spine observation key: - (optional)</li>
</ul>
<p >The history observer reports higher-frequency signals from the spine as vectors of observations to lower-frequency agents. It handles floating-point and vector-valued observations. For instance, to report the left-knee torque readings on an Upkie, create a shared-pointer as follows and add it to the observer pipeline of the spine:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> left_knee_torque_history = std::make_shared&lt;HistoryObserver&lt;double&gt; &gt;(</div>
<div class="line">    <span class="comment">/* keys = */</span> std::vector&lt;std::string&gt;{<span class="stringliteral">&quot;servo&quot;</span>, <span class="stringliteral">&quot;left_knee&quot;</span>, <span class="stringliteral">&quot;torque&quot;</span>},</div>
<div class="line">    <span class="comment">/* size = */</span> 10,</div>
<div class="line">    <span class="comment">/* default_value = */</span> std::numeric_limits&lt;double&gt;::quiet_NaN());</div>
<div class="line">observer_pipeline.append_observer(left_knee_torque_history);</div>
</div><!-- fragment --><p >The same syntax can be used for a vector like the IMU linear acceleration:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> linear_acceleration_history =</div>
<div class="line">    std::make_shared&lt;HistoryObserver&lt;Eigen::Vector3d&gt; &gt;(</div>
<div class="line">        <span class="comment">/* keys = */</span> std::vector&lt;std::string&gt;{<span class="stringliteral">&quot;imu&quot;</span>, <span class="stringliteral">&quot;linear_acceleration&quot;</span>},</div>
<div class="line">        <span class="comment">/* size = */</span> 10,</div>
<div class="line">        <span class="comment">/* default_value = */</span> Eigen::Vector3d::Zero());</div>
<div class="line">observer_pipeline.append_observer(linear_acceleration_history);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md14"></a>
IMU</h1>
<ul>
<li>Observer: always reported</li>
<li>See also: <a class="el" href="structupkie_1_1cpp_1_1interfaces_1_1ImuData.html">ImuData</a></li>
<li>Spine observation key: <code>imu</code></li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>angular_velocity</code>   </td><td class="markdownTableBodyNone"><a class="el" href="structupkie_1_1cpp_1_1interfaces_1_1ImuData_a01702b8f8f9569296865b0d795c7a933.html#a01702b8f8f9569296865b0d795c7a933">Body angular velocity</a> of the IMU frame in rad/s    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>linear_acceleration</code>   </td><td class="markdownTableBodyNone"><a class="el" href="structupkie_1_1cpp_1_1interfaces_1_1ImuData_a8be571760b33280a79ed01aad9477935.html#a8be571760b33280a79ed01aad9477935">Linear acceleration</a> of the IMU, with gravity filtered out, in m/s²    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>orientation</code>   </td><td class="markdownTableBodyNone"><a class="el" href="structupkie_1_1cpp_1_1interfaces_1_1ImuData_a463ead2d78ae4c7fac8a58e6c3946764.html#a463ead2d78ae4c7fac8a58e6c3946764">Orientation of the IMU frame</a> in the <a class="el" href="dev-notes.html#ars">ARS</a> frame as a unit quaternion (w, x, y, z)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>raw_angular_velocity</code>   </td><td class="markdownTableBodyNone"><a class="el" href="structupkie_1_1cpp_1_1interfaces_1_1ImuData_a677203895e0eeb3fd4530b4f80b95974.html#a677203895e0eeb3fd4530b4f80b95974">Raw angular velocity</a> measured by the gyroscope of the IMU, in rad/s    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>raw_linear_acceleration</code>   </td><td class="markdownTableBodyNone"><a class="el" href="structupkie_1_1cpp_1_1interfaces_1_1ImuData_aed54c898f81efd2041aefea7c795a7de.html#aed54c898f81efd2041aefea7c795a7de">Raw linear acceleration</a> measured by the accelerometer of the IMU, in m/s²   </td></tr>
</table>
<p >The inertial measurement unit (IMU) mounted on the <a href="https://mjbots.com/products/mjbots-pi3hat-r4-5">pi3hat</a> combines an accelerometer and a gyroscope. These raw measurements are converted onboard by an unscented Kalman filter (based on a standard quasi-static assumption) that outputs observed quantities with respect to an attitude reference system (ARS) frame.</p>
<p >There are three main frames to keep in mind when considering the IMU: the frame of the IMU sensor itself, the world frame, and the <a class="el" href="dev-notes.html#ars">attitude reference system</a> (ARS) frame. The world frame is an inertial frame of reference we refer to in various observers. It has an x-axis pointing forward, a y-axis pointing to the left and a z-axis vertical and pointing up (<em>i.e.</em>, against the gravity vector).</p>
<h1><a class="anchor" id="autotoc_md15"></a>
Servo</h1>
<ul>
<li>Observer: always reported</li>
<li>Spine observation key: <code>servo</code></li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>&lt;servo_name&gt;</code>   </td><td class="markdownTableBodyNone">Observations for a given servo, *e.g. <code>left_hip</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>&lt;servo_name&gt;.position</code>   </td><td class="markdownTableBodyNone">Angle between the stator and the rotor in radians    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>&lt;servo_name&gt;.torque</code>   </td><td class="markdownTableBodyNone">Joint torque in N⋅m    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>&lt;servo_name&gt;.velocity</code>   </td><td class="markdownTableBodyNone">Angular velocity of the rotor w.r.t. stator in rotor, in rad/s   </td></tr>
</table>
<p >Actuators on the robot are <a href="https://mjbots.com/products/qdd100-beta-3">qdd100 beta 3</a> (hips and knees) and <a href="https://mjbots.com/products/mj5208">mj5208 brushless motors</a> (wheels). All of them have <a href="https://mjbots.com/products/moteus-r4-11">moteus</a> controller boards that provide the above measurements. They are estimated as follows:</p>
<ul>
<li>Joint angle, sensed by two orthogonal Hall-effect sensors at the back of the moteus controller board (each measuring the magnetic field in one direction; the output angle is then the arc-tangent of the ratio between these two values)</li>
<li>Joint velocity, obtained by filtering joint angle measurements (not a direct measurement)</li>
<li>Joint torque, estimated from sensed phase currents (with a model that includes <a href="https://jpieper.com/2020/07/31/dealing-with-stator-magnetic-saturation/">stator magnetic saturation</a>)</li>
</ul>
<h1><a class="anchor" id="autotoc_md16"></a>
Simulation-only</h1>
<ul>
<li>Observer: when using a simulation interface</li>
<li>Spine observation key: <code>sim</code></li>
</ul>
<p >Simulation spines may report the following additional observations.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Floating base</h2>
<ul>
<li>Spine observation key: <code>sim.base</code></li>
</ul>
<p >Positions and velocities of the base frame:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>base.position</code>   </td><td class="markdownTableBodyNone">Position of the base frame in the world frame, in meters    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>base.orientation</code>   </td><td class="markdownTableBodyNone">Unit quaternion (q, x, y, z) of the orientation of the base frame in the world frame    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>base.linear_velocity</code>   </td><td class="markdownTableBodyNone">Linear velocity from base to world in world, in m/s    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>base.angular_velocity</code>   </td><td class="markdownTableBodyNone">Angular velocity from base to world in world, in rad/s   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md18"></a>
IMU non-observables</h2>
<ul>
<li>Spine observation key: <code>sim.imu</code></li>
</ul>
<p >Non-observable quantities related to the IMU:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>linear_velocity</code>   </td><td class="markdownTableBodyNone">Linear velocity of the IMU frame in the world frame, in m/s   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md19"></a>
Rigid bodies</h2>
<ul>
<li>Spine observation key: <code>sim.bodies</code></li>
</ul>
<p >Coordinates of some rigid bodies in the world frame:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>YYY</code>   </td><td class="markdownTableBodyNone">Positions and velocities of the extra body YYY    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>YYY.position</code>   </td><td class="markdownTableBodyNone">Position of YYY in the world frame, in meters    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>YYY.orientation</code>   </td><td class="markdownTableBodyNone">Unit quaternion (q, x, y, z) of the orientation of YYY in the world frame   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md20"></a>
Wheel odometry</h1>
<ul>
<li>Observer: <a class="el" href="classupkie_1_1cpp_1_1observers_1_1WheelOdometry.html">WheelOdometry</a></li>
<li>Spine observation key: <code>wheel_odometry</code></li>
</ul>
<p >This observer measures the relative motion of the robot with respect to the floor, outputting ground position and velocity estimates. These quantities are used for instance in the PID balancer, which tries to stay around the same spot on the floor.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Observation key   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>position</code>   </td><td class="markdownTableBodyNone">Ground position in meters    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>velocity</code>   </td><td class="markdownTableBodyNone">Ground velocity in m/s   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
